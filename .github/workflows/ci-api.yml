# =============================================================================
# CI/CD Pipeline - Core API Service
# =============================================================================
# 
# This workflow builds and deploys the Core API service to Google Cloud Run.
#
# Overview:
#   1. Check if the API service is affected by changes
#   2. Run quality checks (lint, typecheck, test)
#   3. Build the application in CI (faster, cached)
#   4. Build and push Docker image to Artifact Registry
#   5. Deploy to Cloud Run using google-github-actions/deploy-cloudrun
#
# Prerequisites:
#   - Enable Cloud Run API: run.googleapis.com
#   - Enable Artifact Registry API: artifactregistry.googleapis.com
#   - Configure Workload Identity Federation for GitHub
#   - Grant required IAM roles:
#     - roles/run.admin
#     - roles/iam.serviceAccountUser
#     - roles/artifactregistry.admin
#
# Required GitHub Secrets/Variables:
#   - WIF_PROVIDER: Workload Identity Federation provider
#   - WIF_SERVICE_ACCOUNT: Service account email
#   - GCP_PROJECT_ID: Google Cloud project ID
#   - GCP_REGION: Deployment region (e.g., us-central1)
#   - GAR_REPOSITORY: Artifact Registry repository name
#
# =============================================================================

name: CI/CD - Core API Service

on:
  # Automatic deployment on push to main/develop
  push:
    branches: [main, develop]
    paths:
      - 'services/core/**'
      - 'packages/lib/**'
      - '.github/workflows/ci-api.yml'
  
  # Manual deployment trigger
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - staging
        default: 'staging'

env:
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
  
  # Google Cloud configuration
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GAR_LOCATION: ${{ vars.GCP_REGION }}
  REPOSITORY: ${{ vars.GAR_REPOSITORY }}
  SERVICE_NAME: credopass-core
  REGION: ${{ vars.GCP_REGION }}
  
  # Docker image configuration
  IMAGE_NAME: credopass-core
  DOCKERFILE_PATH: services/core/Dockerfile

jobs:
  # ==========================================================================
  # Job 1: Quality checks (lint, typecheck, test)
  # ==========================================================================
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    if: github.ref == format('refs/heads/{0}', github.event.repository.default_branch) || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Derive SHAs for base and head
        if: github.event_name != 'workflow_dispatch'
        uses: nrwl/nx-set-shas@v4

      - name: Lint Core API service
        run: bun nx lint coreservice || echo "No lint configured"

      - name: Type check Core API service
        run: bun nx typecheck coreservice || echo "No typecheck configured"

      - name: Test Core API service
        run: bun nx test coreservice || echo "No tests configured"

  # ==========================================================================
  # Job 3: Build application and Docker image, then deploy to Cloud Run
  # ==========================================================================
  build-and-deploy:
    name: Build & Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: [quality-checks]
    if: always() && !failure() && !cancelled()
    
    # Required permissions for Workload Identity Federation
    permissions:
      contents: 'read'
      id-token: 'write'
    
    environment:
      name: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production') || github.ref == 'refs/heads/main' && 'production-api' || 'staging-api' }}
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      # ----------------------------------------------------------------------
      # Step 1: Checkout and setup
      # ----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # ----------------------------------------------------------------------
      # Step 2: Install dependencies and build in CI
      # ----------------------------------------------------------------------
      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build Core API service
        run: |
          echo "ðŸ“¦ Building Core API service..."
          bun nx build coreservice
          echo "âœ… Build complete!"
          
          # List build artifacts
          echo "ðŸ“ Build artifacts:"
          ls -la dist/services/core/ || echo "Build output directory not found"

      # ----------------------------------------------------------------------
      # Step 3: Authenticate to Google Cloud using Workload Identity Federation
      # ----------------------------------------------------------------------

      # Uncomment below and comment out Workload Identity Federation if needed
      # - name: Authenticate to Google Cloud
      #   id: auth
      #   uses: google-github-actions/auth@v2
      #   with:
      #     token_format: 'access_token'
      #     workload_identity_provider: ${{ vars.WIF_PROVIDER }}
      #     service_account: ${{ vars.WIF_SERVICE_ACCOUNT }}

      # Alternative: Service Account Key JSON authentication
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      # ----------------------------------------------------------------------
      # Step 4: Authenticate Docker to Google Artifact Registry
      # ----------------------------------------------------------------------
      - name: Authenticate Docker to Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GAR_LOCATION }}-docker.pkg.dev
          username: _json_key
          password: ${{ secrets.GCP_CREDENTIALS }}

      # ----------------------------------------------------------------------
      # Step 5: Build and push Docker image
      # ----------------------------------------------------------------------
      - name: Determine environment configuration
        id: env-config
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="production"
          else
            ENV="staging"
          fi
          
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          
          if [ "$ENV" == "production" ]; then
            echo "service_name=credopass-core" >> $GITHUB_OUTPUT
            echo "min_instances=1" >> $GITHUB_OUTPUT
            echo "max_instances=10" >> $GITHUB_OUTPUT
          else
            echo "service_name=credopass-core-staging" >> $GITHUB_OUTPUT
            echo "min_instances=0" >> $GITHUB_OUTPUT
            echo "max_instances=5" >> $GITHUB_OUTPUT
          fi
          
          echo "ðŸŽ¯ Environment: $ENV"

      - name: Build and push Docker image
        id: docker-build
        run: |
          IMAGE_TAG="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}"
          
          echo "ðŸ³ Building Docker image..."
          docker build \
            --file ${{ env.DOCKERFILE_PATH }} \
            --tag "${IMAGE_TAG}:${{ github.sha }}" \
            --tag "${IMAGE_TAG}:latest" \
            --build-arg NODE_ENV=${{ steps.env-config.outputs.environment }} \
            .
          
          echo "ðŸ“¤ Pushing Docker image to Artifact Registry..."
          docker push "${IMAGE_TAG}:${{ github.sha }}"
          docker push "${IMAGE_TAG}:latest"
          
          echo "image=${IMAGE_TAG}:${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "âœ… Docker image pushed successfully!"

      # ----------------------------------------------------------------------
      # Step 6: Deploy to Cloud Run
      # ----------------------------------------------------------------------
      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ steps.env-config.outputs.service_name }}
          region: ${{ env.REGION }}
          image: ${{ steps.docker-build.outputs.image }}
          flags: |
            --port=8080
            --memory=512Mi
            --cpu=1
            --min-instances=${{ steps.env-config.outputs.min_instances }}
            --max-instances=${{ steps.env-config.outputs.max_instances }}
            --timeout=300
            --concurrency=80
            --allow-unauthenticated
          env_vars: |
            NODE_ENV=${{ steps.env-config.outputs.environment }}
          secrets: |
            DATABASE_URL=DATABASE_URL:latest

      # ----------------------------------------------------------------------
      # Step 7: Output deployment summary
      # ----------------------------------------------------------------------
      - name: Deployment summary
        run: |
          echo "## ðŸš€ Core API Service Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | âœ… Deployed successfully |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ steps.env-config.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Service** | ${{ steps.env-config.outputs.service_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **URL** | ${{ steps.deploy.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image** | \`${{ steps.docker-build.outputs.image }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Health Check" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "curl ${{ steps.deploy.outputs.url }}/api/core/health" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
