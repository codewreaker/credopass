name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

jobs:
  # Detect what changed using Nx affected
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      has-changes: ${{ steps.affected.outputs.has-changes }}
      affected-projects: ${{ steps.affected.outputs.projects }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Derive SHAs for base and head
        uses: nrwl/nx-set-shas@v4

      - name: Check affected projects
        id: affected
        run: |
          # Get affected projects
          AFFECTED_PROJECTS=$(bun nx show projects --affected)
          AFFECTED_COUNT=$(echo "$AFFECTED_PROJECTS" | wc -l)
          
          if [ "$AFFECTED_COUNT" -gt 0 ]; then
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "projects=$AFFECTED_PROJECTS" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ $AFFECTED_COUNT project(s) affected:"
            echo "$AFFECTED_PROJECTS"
          else
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "projects=" >> $GITHUB_OUTPUT
            echo "âœ¨ No projects affected"
          fi

  # Lint and test affected projects
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Derive SHAs for base and head
        uses: nrwl/nx-set-shas@v4

      - name: Run linting on affected projects
        run: bun nx affected -t lint --parallel=3 || echo "No lint tasks available"

      - name: Run type checking on affected projects
        run: bun nx affected -t typecheck --parallel=3 || echo "No typecheck tasks available"

      - name: Run tests on affected projects
        run: bun nx affected -t test --parallel=3 || echo "No test tasks available"

      - name: Build affected projects
        run: bun nx affected -t build --parallel=3

  # Summary
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, quality-checks]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## âœ… CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.detect-changes.outputs.has-changes }}" == "true" ]; then
            echo "**Affected Projects:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "${{ needs.detect-changes.outputs.affected-projects }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ¨ No projects affected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.quality-checks.result }}" == "success" ]; then
            echo "âœ… **Quality Checks**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.quality-checks.result }}" == "skipped" ]; then
            echo "â­ï¸ **Quality Checks**: Skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Quality Checks**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Note**: Deployments run in separate workflows" >> $GITHUB_STEP_SUMMARY
          echo "- Web App: \`deploy-web.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "- API Service: \`deploy-api.yml\`" >> $GITHUB_STEP_SUMMARY
